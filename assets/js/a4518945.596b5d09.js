"use strict";(self.webpackChunk_1j1s_main_cms_docs=self.webpackChunk_1j1s_main_cms_docs||[]).push([[78],{2098:(e,n,s)=>{s.r(n),s.d(n,{assets:()=>a,contentTitle:()=>c,default:()=>p,frontMatter:()=>l,metadata:()=>r,toc:()=>t});var o=s(4848),i=s(8453);const l={sidebar_label:"Comment copier les donn\xe9es Meilisearch en local ?",sidebar_position:2},c="Comment copier les donn\xe9es Meilisearch en local ?",r={id:"tuto/copie-donnee-en-local",title:"Comment copier les donn\xe9es Meilisearch en local ?",description:"23 Juillet 2024 (mis \xe0 jour le 21 Ao\xfbt 2024)",source:"@site/docs/tuto/copie-donnee-en-local.md",sourceDirName:"tuto",slug:"/tuto/copie-donnee-en-local",permalink:"/1j1s-main-cms/docs/tuto/copie-donnee-en-local",draft:!1,unlisted:!1,editUrl:"https://github.com/DNUM-SocialGouv/1j1s-main-cms/tree/main/docs/docs/docs/tuto/copie-donnee-en-local.md",tags:[],version:"current",sidebarPosition:2,frontMatter:{sidebar_label:"Comment copier les donn\xe9es Meilisearch en local ?",sidebar_position:2},sidebar:"tutorialSidebar",previous:{title:"Comment resynchroniser les donn\xe9es Meilisearch avec celles de Strapi ?",permalink:"/1j1s-main-cms/docs/tuto/resynchronisation-meilisearch-strapi"},next:{title:"Que faire si l'indexation des donn\xe9es Meilisearch reste bloqu\xe9e \xe0 10000 donn\xe9es dans Strapi ?",permalink:"/1j1s-main-cms/docs/tuto/fixer-la-synchro-meilisearch"}},a={},t=[{value:"Copie des donn\xe9es de recette en local",id:"copie-des-donn\xe9es-de-recette-en-local",level:2},{value:"Pr\xe9-requis",id:"pr\xe9-requis",level:3},{value:"Variables d&#39;environnement utiles",id:"variables-denvironnement-utiles",level:3},{value:"Connexion",id:"connexion",level:3},{value:"T\xe9l\xe9chargement de la Backup",id:"t\xe9l\xe9chargement-de-la-backup",level:3},{value:"Monter la backup dans le conteneur local",id:"monter-la-backup-dans-le-conteneur-local",level:3}];function d(e){const n={a:"a",admonition:"admonition",code:"code",em:"em",h1:"h1",h2:"h2",h3:"h3",header:"header",p:"p",pre:"pre",...(0,i.R)(),...e.components};return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)(n.header,{children:(0,o.jsx)(n.h1,{id:"comment-copier-les-donn\xe9es-meilisearch-en-local-",children:"Comment copier les donn\xe9es Meilisearch en local ?"})}),"\n",(0,o.jsx)(n.p,{children:(0,o.jsx)(n.em,{children:"23 Juillet 2024 (mis \xe0 jour le 21 Ao\xfbt 2024)"})}),"\n",(0,o.jsx)(n.admonition,{title:"Contexte",type:"info",children:(0,o.jsx)(n.p,{children:"Vous souhaiter savoir comment r\xe9aliser la copie des donn\xe9es Meilisearch du CMS vers une version locale afin de r\xe9aliser par exemple, l'indexation depuis un strapi branch\xe9 \xe0 Meilisearch version locale, connect\xe9 aux url de Recette ou Prod."})}),"\n",(0,o.jsx)(n.h2,{id:"copie-des-donn\xe9es-de-recette-en-local",children:"Copie des donn\xe9es de recette en local"}),"\n",(0,o.jsxs)(n.p,{children:["Le script ",(0,o.jsx)(n.code,{children:"populate-with-recette-data.sh"})," \xe0 la racine a \xe9t\xe9 mis en place pour la copie des donn\xe9es du CMS de recette vers le CMS conteneuris\xe9.\nCi-dessous l'explication du fonctionnement de ce script."]}),"\n",(0,o.jsx)(n.h3,{id:"pr\xe9-requis",children:"Pr\xe9-requis"}),"\n",(0,o.jsxs)(n.admonition,{title:"Configuration",type:"danger",children:[(0,o.jsxs)(n.p,{children:["Afin de pouvoir ex\xe9cuter le script, il faut avoir copi\xe9 le contenu de ",(0,o.jsx)(n.code,{children:".env.docker"})," dans ",(0,o.jsx)(n.code,{children:".env"}),"."]}),(0,o.jsx)(n.p,{children:"Ensuite, vous devez avoir en votre possession une clef vous permettant de vous connecter sur l'environnement depuis lequel l'on veut copier.\nPour la g\xe9n\xe9rer : il suffit de se connecter sur son compte Scalingo et g\xe9n\xe9rer un API Token."}),(0,o.jsxs)(n.p,{children:["Cette clef (API Token) est \xe0 remplir dans la variable d'environnement ",(0,o.jsx)(n.code,{children:"SCALINGO_API_TOKEN"})," dans ",(0,o.jsx)(n.code,{children:".env"}),"."]}),(0,o.jsxs)(n.p,{children:["Pour manipuler les conteneurs et applications sur Scalingo, il vous faudra ",(0,o.jsx)(n.a,{href:"https://doc.scalingo.com/platform/cli/start#install-scalingo-cli",children:"installer leur CLI"})]}),(0,o.jsxs)(n.p,{children:["Vous pouvez ex\xe9cuter la commande suivante pour installer ou mettre \xe0 jour ",(0,o.jsx)(n.code,{children:"Scalingo CLI"}),":"]}),(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-/bin/bash",children:"$ curl -O https://cli-dl.scalingo.com/install && bash install\n"})})]}),"\n",(0,o.jsx)(n.h3,{id:"variables-denvironnement-utiles",children:"Variables d'environnement utiles"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-/bin/bash",children:"# populate-with-recette-data.sh\n\nexport SCALINGO_APP='1j1s-main-cms'\nexport SCALINGO_REGION='osc-fr1'\nexport ADDON_NAME='postgresql'\nexport SCALINGO_DB_USER='<l'utilisateur db prod>'\n"})}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-/bin/bash",children:"# .env\n\nSCALINGO_API_TOKEN='<la clef API de Scalingo>'\n"})}),"\n",(0,o.jsx)(n.h3,{id:"connexion",children:"Connexion"}),"\n",(0,o.jsxs)(n.p,{children:["Dans un premier temps, il faut se connecter avec la clef r\xe9cup\xe9r\xe9e ci-dessus.\nUne v\xe9rification est faite en amont pour arr\xeater le script s'il n'y a pas de ",(0,o.jsx)(n.code,{children:".env"})," local."]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-/bin/bash",children:"if [ -f .env ]\nthen\n  export $(cat .env | xargs)\nelse\n  exit 1\nfi\n\nscalingo login --api-token ${API_TOKEN}\n"})}),"\n",(0,o.jsx)(n.h3,{id:"t\xe9l\xe9chargement-de-la-backup",children:"T\xe9l\xe9chargement de la Backup"}),"\n",(0,o.jsx)(n.p,{children:"Pour t\xe9l\xe9charger la derni\xe8re backup de la BDD en recette, on lance les commandes suivantes :"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-/bin/bash",children:"addon_id=$(scalingo addons | grep $ADDON_NAME | cut -d'|' -f3 | tr -d ' ')\nmkdir -p tmp && cd tmp\nscalingo --addon ${addon_id} backups-download --output ./backup\ntar -xvf ./backup\nfor filename in *.pgsql; do eval mv \\\"$filename\\\" \\\"backup.pgsql\\\"; done\ncd ..\n"})}),"\n",(0,o.jsxs)(n.p,{children:["A ce stade, nous avons un fichier ",(0,o.jsx)(n.code,{children:"backup.psql"})," dans le dossier ",(0,o.jsx)(n.code,{children:"tmp"})," qui contient la BDD de recette."]}),"\n",(0,o.jsx)(n.h3,{id:"monter-la-backup-dans-le-conteneur-local",children:"Monter la backup dans le conteneur local"}),"\n",(0,o.jsx)(n.p,{children:"Une fois le t\xe9l\xe9chargement termin\xe9, il suffit de lancer le docker de BDD en lui chargeant le fichier."}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-/bin/bash",children:'docker compose down -v\ndocker compose --env-file .env.docker up -d db\nsleep 5\ndocker compose exec db psql "${DATABASE_URL}" -c "CREATE USER ${SCALINGO_DB_USER} SUPERUSER;"\ndocker compose cp ./tmp/backup.pgsql db:/tmp/backup.pgsql\ndocker compose exec db pg_restore -d ${DATABASE_URL} /tmp/backup.pgsql\n'})})]})}function p(e={}){const{wrapper:n}={...(0,i.R)(),...e.components};return n?(0,o.jsx)(n,{...e,children:(0,o.jsx)(d,{...e})}):d(e)}},8453:(e,n,s)=>{s.d(n,{R:()=>c,x:()=>r});var o=s(6540);const i={},l=o.createContext(i);function c(e){const n=o.useContext(l);return o.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function r(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:c(e.components),o.createElement(l.Provider,{value:n},e.children)}}}]);